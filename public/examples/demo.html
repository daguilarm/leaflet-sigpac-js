<!DOCTYPE html>
<html lang="es" x-data="app()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGPAC Map Viewer | Reactivo</title>
  
  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1d4ed8',
            secondary: '#0f766e',
            accent: '#7e22ce'
          }
        }
      }
    }
  </script>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .map-container {
      height: calc(100vh - 3.5rem);
    }
    
    .toggle-checkbox:checked {
      right: 0;
      border-color: #1d4ed8;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #1d4ed8;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-gradient-to-r from-primary to-accent text-white py-3 px-4 shadow-lg">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
        <div>
          <h1 class="text-xl font-bold">SIGPAC Map Viewer</h1>
          <p class="text-sm opacity-80">Reactivo con Alpine.js</p>
        </div>
      </div>
      <div class="mt-2 md:mt-0 flex items-center space-x-2">
        <span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">Leaflet.js</span>
        <span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">SIGPAC API</span>
        <span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">Alpine.js</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="flex flex-col lg:flex-row h-full">
    <!-- Control Panel -->
    <div class="w-full lg:w-96 bg-white shadow-lg p-4 overflow-y-auto">
      <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Configuración Reactiva</h2>
      
      <!-- General Settings -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
          </svg>
          Configuración General
        </h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Modo Debug</label>
          <div class="relative inline-block w-10 mr-2 align-middle select-none">
            <input type="checkbox" x-model="config.debug" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer">
            <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
          </div>
          <span class="text-xs text-gray-500">Habilita logs detallados en consola</span>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Ocultar Atribución</label>
          <div class="relative inline-block w-10 mr-2 align-middle select-none">
            <input type="checkbox" x-model="config.hideLeafletAttribution" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer">
            <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
          </div>
          <span class="text-xs text-gray-500">Oculta la atribución de Leaflet</span>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Zoom Mínimo para Características</label>
          <input type="number" x-model="config.minZoomFeature" min="1" max="20" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
          <span class="text-xs text-gray-500">Zoom mínimo para mostrar características</span>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Clics Habilitados</label>
          <div class="relative inline-block w-10 mr-2 align-middle select-none">
            <input type="checkbox" x-model="config.clickEnabled" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer">
            <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
          </div>
          <span class="text-xs text-gray-500">Habilita interacciones al hacer clic</span>
        </div>
      </div>
      
      <!-- Interaction Settings -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-secondary" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
          </svg>
          Configuración de Interacción
        </h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Modo de Interacción</label>
          <select x-model="config.interactionMode" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
            <option value="popup">Popup</option>
            <option value="marker">Marcador</option>
          </select>
        </div>
        
        <div x-show="config.interactionMode === 'popup'" class="bg-blue-50 p-3 rounded-md">
          <h4 class="font-medium text-blue-800 mb-2">Configuración de Popup</h4>
          <textarea x-model="config.popupFields" class="w-full h-32 p-2 text-xs font-mono border border-blue-200 rounded bg-white" placeholder="Ejemplo: [
  { label: 'Provincia:', value: parcelaData.provincia },
  { label: 'Municipio:', value: parcelaData.municipio },
  { label: 'Polígono:', value: parcelaData.poligono },
  { label: 'Parcela:', value: parcelaData.parcela },
  { label: 'Superficie:', value: parcelaData.superficie, suffix: 'ha' }
]"></textarea>
          <button @click="applyPopupConfig()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-2 rounded">
            Aplicar Configuración
          </button>
          <p class="mt-1 text-xs text-gray-600">Introduce un array JavaScript válido</p>
        </div>
      </div>
      
      <!-- Cache Settings -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 13.047 14.01c-.04.27-.166.518-.35.704l-1.2 1.2a1 1 0 01-1.4 0l-1.2-1.2a1.2 1.2 0 01-.35-.704L9.854 7.2 11.033 2.744A1 1 0 0112 2z" clip-rule="evenodd" />
          </svg>
          Configuración de Caché
        </h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Habilitar Caché</label>
          <div class="relative inline-block w-10 mr-2 align-middle select-none">
            <input type="checkbox" x-model="cacheConfig.enabled" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer">
            <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">TTL (minutos)</label>
            <input type="number" x-model="cacheConfig.ttl" min="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Entradas Máximas</label>
            <input type="number" x-model="cacheConfig.maxSize" min="1" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
          </div>
        </div>
        
        <div class="bg-purple-50 p-3 rounded-md">
          <h4 class="font-medium text-purple-800 mb-1">Información de Caché</h4>
          <div class="text-xs">
            <p>Estado: 
              <span x-text="cacheConfig.enabled ? 'Activo' : 'Inactivo'" 
                    :class="cacheConfig.enabled ? 'text-green-600 font-semibold' : 'text-gray-600 font-semibold'"></span>
            </p>
            <p>Entradas: <span x-text="cacheEntries" class="font-semibold"></span>/<span x-text="cacheConfig.maxSize" class="font-semibold"></span></p>
            <p>Precisión: <span class="font-semibold">4</span> decimales</p>
          </div>
          <button @click="clearCache()" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 text-white text-xs py-1 px-2 rounded">
            Limpiar Caché
          </button>
        </div>
      </div>
      
      <!-- Map Settings -->
      <div class="p-4 bg-gray-50 rounded-lg">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293a1 1 0 00-1.414 0l-1 1a1 1 0 000 1.414l1.586 1.586a1 1 0 010 1.414l6.586 6.586a1 1 0 001.414 0l3.586-3.586a1 1 0 000-1.414l-6.586-6.586a1 1 0 00-1.414 0l-3.586 3.586z" clip-rule="evenodd" />
          </svg>
          Configuración del Mapa
        </h3>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Latitud</label>
            <input type="text" x-model="mapCenter.lat" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Longitud</label>
            <input type="text" x-model="mapCenter.lng" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nivel de Zoom</label>
          <input type="number" x-model="mapZoom" min="1" max="20" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
        </div>
        
        <div class="flex space-x-2">
          <button @click="resetMap()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-md text-sm">
            Restablecer Mapa
          </button>
          <button @click="locateMe()" class="flex-1 bg-secondary hover:bg-teal-700 text-white py-2 px-3 rounded-md text-sm flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Mi Ubicación
          </button>
        </div>
      </div>
    </div>
    
    <!-- Map Container -->
    <div class="flex-1 relative">
      <div id="map" class="map-container w-full"></div>
      
      <!-- Map Controls -->
      <div class="absolute top-4 right-4 z-[1000] flex flex-col gap-2">
        <button @click="locateMe()" class="bg-white p-2 rounded-full shadow-md hover:bg-gray-50" title="Mi Ubicación">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
        <button @click="clearFeatures()" class="bg-white p-2 rounded-full shadow-md hover:bg-gray-50" title="Limpiar Características">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
      
      <!-- Status Bar -->
      <div class="absolute bottom-4 left-4 z-[1000] bg-white bg-opacity-90 px-3 py-2 rounded-md shadow-md text-sm flex items-center">
        <span id="coordinates" x-text="coordinates" class="text-gray-700"></span>
        <span x-text="`${featureCount} ${featureCount === 1 ? 'característica' : 'características'}`" class="ml-3 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full"></span>
      </div>
      
      <!-- Info Panel -->
      <div id="infoPanel" x-show="infoPanelVisible" class="absolute top-4 left-4 z-[1000] bg-white bg-opacity-90 max-w-xs p-4 rounded-md shadow-md">
        <h4 class="font-bold text-gray-800 mb-2">Información de Parcela</h4>
        <div id="parcelDetails" class="text-sm" x-html="parcelDetails"></div>
        <button @click="infoPanelVisible = false" class="mt-3 text-xs text-blue-600 hover:text-blue-800">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Load SIGPAC Library -->
  <link rel="stylesheet" href="../dist/assets/css/leaflet-sigpac.min.css" />
  <script type="module" src="../dist/assets/js/leaflet-sigpac.es.min.js"></script>

  <script>
    function app() {
      return {
        // Estado de la aplicación
        config: {
          debug: true,
          hideLeafletAttribution: false,
          minZoomFeature: 12,
          clickEnabled: true,
          interactionMode: 'marker',
          popupFields: `[
            { "label": "Provincia:", "value": "parcelaData.provincia" },
            { "label": "Municipio:", "value": "parcelaData.municipio" },
            { "label": "Polígono:", "value": "parcelaData.poligono" },
            { "label": "Parcela:", "value": "parcelaData.parcela" },
            { "label": "Superficie:", "value": "parcelaData.superficie", "suffix": "ha" }
          ]`
        },
        cacheConfig: {
          enabled: true,
          ttl: 5, // minutos
          maxSize: 100
        },
        mapCenter: {
          lat: 37.718387,
          lng: -0.874100
        },
        mapZoom: 15,
        mapManager: null,
        markers: [],
        infoPanelVisible: false,
        parcelDetails: '',
        coordinates: '37.7184° N, -0.8741° W',
        featureCount: 0,
        cacheEntries: 0,
        sigpacLoaded: false,
        
        // Inicialización
        init() {
          // Verificar si la librería SIGPAC está cargada
          if (window.LeafletSigpac) {
            this.sigpacLoaded = true;
            this.initMap();
          } else {
            // Esperar a que cargue la librería
            setTimeout(() => {
              if (window.LeafletSigpac) {
                this.sigpacLoaded = true;
                this.initMap();
              } else {
                console.error('La librería SIGPAC no se ha cargado correctamente');
              }
            }, 500);
          }
          
          // Actualizar información de la caché (simulada)
          this.updateCacheInfo();
          
          // Configurar observadores para cambios en la configuración
          this.setupWatchers();
        },
        
        // Inicializar el mapa
        initMap() {
          if (!this.sigpacLoaded) return;
          
          // Si ya existe un mapa, lo eliminamos
          if (this.mapManager && this.mapManager.map) {
            this.mapManager.map.remove();
          }

          // Construir objeto de configuración para el MapManager
          const config = {
            debug: this.config.debug,
            hideLeafletAttribution: this.config.hideLeafletAttribution,
            minZoomFeature: this.config.minZoomFeature,
            clickEnabled: this.config.clickEnabled,
            interactionMode: this.config.interactionMode,
            popupFields: this.parsePopupFields(),
            cacheConfig: {
              enabled: this.cacheConfig.enabled,
              ttl: this.cacheConfig.ttl * 60 * 1000, // convertir a milisegundos
              maxSize: this.cacheConfig.maxSize,
              precision: 4
            },
            defaultMapOptions: {
              center: [this.mapCenter.lat, this.mapCenter.lng],
              zoom: this.mapZoom,
              tileUrl: 'https://tms-pnoa-ma.idee.es/1.0.0/pnoa-ma/{z}/{x}/{-y}.jpeg',
              attribution: '<a href="https://www.scne.es/">CC BY 4.0 scne.es</a>'
            }
          };
          
          // Inicializar el map manager
          this.mapManager = new window.LeafletSigpac.MapManager(config);
          
          // Inicializar el mapa
          this.mapManager.init(document.getElementById('map'));
          
          // Añadir listeners al mapa
          this.mapManager.map.on('move', () => this.updateCoordinates());
          this.mapManager.map.on('click', (e) => this.handleMapClick(e));
          
          // Actualizar coordenadas iniciales
          this.updateCoordinates();
          
          // Actualizar contador de características
          this.featureCount = 0;
        },
        
        // Analizar los campos del popup
        parsePopupFields() {
          try {
            const fields = JSON.parse(this.config.popupFields);
            return (parcelaData) => {
              return fields.map(field => {
                return {
                  label: field.label,
                  value: field.value.startsWith('parcelaData.') 
                    ? eval(field.value) // Solo para demo, en producción sería mejor evitar eval
                    : field.value,
                  suffix: field.suffix
                };
              });
            };
          } catch (e) {
            console.error('Error al analizar campos del popup:', e);
            return (parcelaData) => [];
          }
        },
        
        // Manejar clic en el mapa
        handleMapClick(e) {
          if (!this.config.clickEnabled || !this.mapManager) return;
          
          // Simular datos de parcela
          const parcelData = {
            provincia: 'Murcia',
            municipio: 'Cartagena',
            poligono: Math.floor(Math.random() * 100),
            parcela: Math.floor(Math.random() * 500),
            superficie: (Math.random() * 10).toFixed(2)
          };
          
          // Actualizar contador de características
          this.featureCount++;
          
          if (this.config.interactionMode === 'marker') {
            // Añadir marcador
            const marker = L.marker(e.latlng).addTo(this.mapManager.map);
            marker.bindPopup(`
              <div class="text-sm">
                <div class="font-bold">Información de Parcela</div>
                <div>Provincia: ${parcelData.provincia}</div>
                <div>Municipio: ${parcelData.municipio}</div>
                <div>Polígono: ${parcelData.poligono}</div>
                <div>Parcela: ${parcelData.parcela}</div>
                <div>Superficie: ${parcelData.superficie} ha</div>
              </div>
            `);
            this.markers.push(marker);
            marker.openPopup();
          } else {
            // Mostrar información en el panel
            this.showParcelInfo(parcelData);
          }
        },
        
        // Mostrar información de parcela
        showParcelInfo(data) {
          this.parcelDetails = `
            <div class="grid grid-cols-2 gap-2">
              <div class="font-medium">Provincia:</div>
              <div>${data.provincia}</div>
              
              <div class="font-medium">Municipio:</div>
              <div>${data.municipio}</div>
              
              <div class="font-medium">Polígono:</div>
              <div>${data.poligono}</div>
              
              <div class="font-medium">Parcela:</div>
              <div>${data.parcela}</div>
              
              <div class="font-medium">Superficie:</div>
              <div>${data.superficie} ha</div>
            </div>
          `;
          
          // Mostrar el panel de información
          this.infoPanelVisible = true;
          
          // Ocultar automáticamente después de 10 segundos
          setTimeout(() => {
            this.infoPanelVisible = false;
          }, 10000);
        },
        
        // Mostrar mensaje en el panel de información
        showInfo(message) {
          this.parcelDetails = `<div class="text-center py-2">${message}</div>`;
          this.infoPanelVisible = true;
          
          // Ocultar automáticamente después de 5 segundos
          setTimeout(() => {
            this.infoPanelVisible = false;
          }, 5000);
        },
        
        // Actualizar coordenadas
        updateCoordinates() {
          if (this.mapManager && this.mapManager.map) {
            const center = this.mapManager.map.getCenter();
            this.coordinates = `${center.lat.toFixed(4)}° N, ${center.lng.toFixed(4)}° W`;
          }
        },
        
        // Actualizar información de caché (simulada)
        updateCacheInfo() {
          this.cacheEntries = this.cacheConfig.enabled ? 
            Math.floor(Math.random() * 20) : 0;
        },
        
        // Configurar observadores para cambios en la configuración
        setupWatchers() {
          // Observar cambios en la configuración que requieren reiniciar el mapa
          this.$watch('mapCenter', () => {
            if (this.mapManager && this.mapManager.map) {
              this.mapManager.map.setView([
                parseFloat(this.mapCenter.lat),
                parseFloat(this.mapCenter.lng)
              ], this.mapZoom);
            }
          }, { deep: true });
          
          this.$watch('mapZoom', (newVal) => {
            if (this.mapManager && this.mapManager.map) {
              this.mapManager.map.setZoom(parseInt(newVal));
            }
          });
          
          // Observar cambios en la caché
          this.$watch('cacheConfig', () => {
            if (this.mapManager && this.sigpacLoaded) {
              this.mapManager.config.cacheConfig = {
                enabled: this.cacheConfig.enabled,
                ttl: this.cacheConfig.ttl * 60 * 1000,
                maxSize: this.cacheConfig.maxSize,
                precision: 4
              };
              
              // Actualizar caché
              if (this.mapManager.subsystems.sigpacService.cache) {
                this.mapManager.subsystems.sigpacService.cache = 
                  new window.LeafletSigpac.CoordinateCache(this.mapManager.config.cacheConfig);
              }
              
              this.updateCacheInfo();
            }
          }, { deep: true });
          
          // Observar cambios en la configuración general
          this.$watch('config', () => {
            if (this.mapManager && this.sigpacLoaded) {
              // Actualizar configuración en tiempo real
              this.mapManager.config.debug = this.config.debug;
              this.mapManager.config.hideLeafletAttribution = this.config.hideLeafletAttribution;
              this.mapManager.config.minZoomFeature = parseInt(this.config.minZoomFeature);
              this.mapManager.config.clickEnabled = this.config.clickEnabled;
              this.mapManager.config.interactionMode = this.config.interactionMode;
              
              // Actualizar atribución si es necesario
              if (this.mapManager.map && this.mapManager.config.hideLeafletAttribution) {
                this.mapManager.map.attributionControl.setPrefix('');
              } else {
                this.mapManager.map.attributionControl.setPrefix('Leaflet');
              }
            }
          }, { deep: true });
          
          // Actualizar información de caché periódicamente
          setInterval(() => this.updateCacheInfo(), 5000);
        },
        
        // Aplicar configuración de popup
        applyPopupConfig() {
          try {
            const popupFields = JSON.parse(this.config.popupFields);
            if (this.mapManager && this.sigpacLoaded) {
              this.mapManager.config.popupFields = this.parsePopupFields();
              this.showInfo('Configuración de popup aplicada con éxito!');
            }
          } catch (e) {
            this.showInfo('Error: Formato JSON inválido para campos de popup');
          }
        },
        
        // Limpiar caché
        clearCache() {
          if (this.mapManager && this.mapManager.subsystems.sigpacService.cache && this.sigpacLoaded) {
            this.mapManager.subsystems.sigpacService.cache.clear();
            this.cacheEntries = 0;
            this.showInfo('Caché limpiada con éxito!');
          }
        },
        
        // Restablecer mapa a posición inicial
        resetMap() {
          this.mapCenter = { lat: 37.718387, lng: -0.874100 };
          this.mapZoom = 15;
          this.showInfo('Mapa restablecido a posición inicial');
        },
        
        // Localizar mi posición
        locateMe() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
              this.mapCenter = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              this.mapZoom = 15;
              this.showInfo('Ubicación establecida a tu posición actual');
            }, (error) => {
              this.showInfo('No se pudo obtener tu ubicación: ' + error.message);
            });
          } else {
            this.showInfo('Geolocalización no soportada por tu navegador');
          }
        },
        
        // Limpiar características
        clearFeatures() {
          if (this.mapManager && this.mapManager.map) {
            this.markers.forEach(marker => this.mapManager.map.removeLayer(marker));
          }
          this.markers = [];
          this.featureCount = 0;
          this.showInfo('Todas las características han sido eliminadas');
        }
      };
    }
  </script>
</body>
</html>